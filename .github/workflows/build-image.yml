name: Build Raspberry Pi 4 Terminal Image

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version'
        required: false
        default: '1.0.0'
        type: string
      server_address:
        description: 'Cache server address'
        required: false
        default: 'ubuntu@119.91.232.180'
        type: string
      server_password:
        description: 'Server SSH password'
        required: true
        type: string

jobs:
  download-downloads-cache:
    name: Download downloads cache
    runs-on: ubuntu-24.04
    steps:
      - name: Download downloads cache
        env:
          SERVER_ADDR: ${{ inputs.server_address }}
          SERVER_PASS: ${{ inputs.server_password }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          mkdir -p downloads
          echo "Downloading downloads cache from $SERVER_ADDR..."
          sshpass -p "$SERVER_PASS" rsync -avz --stats \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ${SERVER_ADDR}:~/raspberrypi-yocto-terminal/build-cache/downloads/ \
            downloads/ || echo "Warning: downloads cache failed"
          du -sh downloads/

      - name: Upload downloads cache
        uses: actions/upload-artifact@v4
        with:
          name: downloads-cache
          path: downloads/
          retention-days: 1

  download-sstate-cache:
    name: Download sstate cache
    runs-on: ubuntu-24.04
    steps:
      - name: Download sstate-cache
        env:
          SERVER_ADDR: ${{ inputs.server_address }}
          SERVER_PASS: ${{ inputs.server_password }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          mkdir -p sstate-cache
          echo "Downloading sstate-cache from $SERVER_ADDR..."
          sshpass -p "$SERVER_PASS" rsync -avz --stats \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ${SERVER_ADDR}:~/raspberrypi-yocto-terminal/build-cache/sstate-cache/ \
            sstate-cache/ || echo "Warning: sstate-cache failed"
          du -sh sstate-cache/

      - name: Upload sstate-cache
        uses: actions/upload-artifact@v4
        with:
          name: sstate-cache
          path: sstate-cache/
          retention-days: 1

  build-yocto-image:
    name: Build Yocto Image
    runs-on: ubuntu-24.04
    needs: [download-downloads-cache, download-sstate-cache]
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 3072
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: layers/raspberrypi-yocto-terminal
          fetch-depth: 0

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gawk wget git diffstat unzip texinfo gcc build-essential \
            chrpath socat cpio python3-pexpect xz-utils debianutils \
            iputils-ping python3-git python3-pip python3-jinja2 \
            libsdl1.2-dev xterm python3-subunit zstd liblz4-tool file locales

          sudo pip3 install kas

          sudo locale-gen --purge "en_US.UTF-8"
          sudo update-locale "LANG=en_US.UTF-8"
          sudo dpkg-reconfigure --frontend noninteractive locales

          sudo rm -f /bin/sh && sudo ln -s bash /bin/sh

          sudo tee /etc/apparmor.d/bitbake << EOF
          abi <abi/4.0>,
          include <tunables/global>
          profile bitbake /**/bitbake/bin/bitbake flags=(unconfined) {
            userns,
          }
          EOF
          sudo apparmor_parser -r /etc/apparmor.d/bitbake

          kas --version

      - name: Download downloads cache artifact
        uses: actions/download-artifact@v4
        with:
          name: downloads-cache
          path: build/downloads/

      - name: Download sstate-cache artifact
        uses: actions/download-artifact@v4
        with:
          name: sstate-cache
          path: build/sstate-cache/

      - name: Verify cache
        run: |
          echo "Cache status:"
          du -sh build/downloads/ build/sstate-cache/ 2>/dev/null || echo "Cache not found"
          df -h

      - name: Build Yocto image
        env:
          KAS_WORK_DIR: ${{ github.workspace }}
        run: |
          echo "Starting build at $(date)"
          kas build layers/raspberrypi-yocto-terminal/kas/raspberrypi-yocto-terminal.yml
          echo "Build completed at $(date)"

      - name: Prepare release artifacts
        id: artifacts
        run: |
          BUILD_DATE=$(date -u +"%Y%m%d_%H%M%S")
          SHORT_DATE=$(date -u +"%Y%m%d")
          BUILD_ID="raspberrypi4-terminal_${SHORT_DATE}_${GITHUB_SHA:0:8}"
          
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "SHORT_DATE=$SHORT_DATE" >> $GITHUB_OUTPUT
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=${{ inputs.release_version }}" >> $GITHUB_OUTPUT

          mkdir -p release
          DEPLOY_DIR="build/tmp/deploy/images/raspberrypi4"

          if [ -d "$DEPLOY_DIR" ]; then
            if [ -f "$DEPLOY_DIR/core-image-minimal-raspberrypi4.sdimg" ]; then
              cp "$DEPLOY_DIR/core-image-minimal-raspberrypi4.sdimg" \
                 "release/raspberrypi-yocto-terminal.img"
            fi

            if [ -f "$DEPLOY_DIR/core-image-minimal-raspberrypi4.wic.bz2" ]; then
              cp "$DEPLOY_DIR/core-image-minimal-raspberrypi4.wic.bz2" \
                 "release/raspberrypi-yocto-terminal.wic.bz2"
            fi
          else
            echo "Error: Deploy directory not found!"
            exit 1
          fi

          cat > release/build_info.txt << EOF
          Raspberry Pi 4 Yocto Terminal Image
          ====================================
          
          Version: ${{ inputs.release_version }}
          Build ID: ${BUILD_ID}
          Date: ${BUILD_DATE}
          Commit: ${GITHUB_SHA:0:8}
          
          Files:
          - raspberrypi-yocto-terminal.img - SD card image
          - raspberrypi-yocto-terminal.wic.bz2 - Compressed image
          EOF

          ls -lh release/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yocto-images
          path: release/
          retention-days: 1

      - name: Build summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ inputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.artifacts.outputs.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: ${{ steps.artifacts.outputs.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "release" ]; then
            echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
            for file in release/*; do
              if [ -f "$file" ]; then
                echo "- \`$(basename $file)\` ($(ls -lh $file | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: build-yocto-image
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: yocto-images
          path: release/

      - name: Get build info
        id: info
        run: |
          if [ -f release/build_info.txt ]; then
            cat release/build_info.txt
            BUILD_DATE=$(grep "Date:" release/build_info.txt | cut -d: -f2- | xargs)
            BUILD_ID=$(grep "Build ID:" release/build_info.txt | cut -d: -f2- | xargs)
            COMMIT=$(grep "Commit:" release/build_info.txt | cut -d: -f2- | xargs)
            echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
            echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
            echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${{ github.event.inputs.release_version }}"
          RELEASE_NAME="Raspberry Pi 4 Terminal v${{ github.event.inputs.release_version }}"

          cat > release_notes.md << EOF
          ## Raspberry Pi 4 Yocto Terminal
          
          **Version**: ${{ github.event.inputs.release_version }}  
          **Built**: ${{ steps.info.outputs.BUILD_DATE }}  
          **Commit**: ${{ steps.info.outputs.COMMIT }}
          
          ### Installation
          \`\`\`bash
          sudo dd if=raspberrypi-yocto-terminal.img of=/dev/sdX bs=4M status=progress && sync
          \`\`\`
          
          ### Files
          - \`raspberrypi-yocto-terminal.img\` - SD card image
          - \`raspberrypi-yocto-terminal.wic.bz2\` - Compressed image  
          - \`build_info.txt\` - Build information
          EOF

          if gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "Deleting existing release $TAG_NAME"
            gh release delete "$TAG_NAME" -y
          fi

          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md \
            release/*

          echo "âœ… Release created: ${{ github.server_url }}/${{ github.repository }}/releases/tag/$TAG_NAME"

      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: raspberrypi-yocto-terminal-v${{ github.event.inputs.release_version }}
          path: release/
          retention-days: 30
